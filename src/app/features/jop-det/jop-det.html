<!-- Loading State -->
@if (isLoading()) {
<section class="container mx-auto lg:px-20 py-20">
    <div class="flex flex-col items-center justify-center min-h-[60vh]" >
        <div class="loading-spinner mb-6"></div>
        <p class="text-xl text-[#440000]">جاري تحميل بيانات الوظيفة...</p>
    </div>
</section>
}

<!-- Error State -->
@else if (hasError() && !hasJob()) {
<section class="container mx-auto lg:px-20 py-20">
    <div class="flex flex-col items-center justify-center min-h-[60vh] text-center" >
        <div class="mb-6">
            <svg class="w-24 h-24 text-[#ED2924] mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                </path>
            </svg>
        </div>
        <h2 class="text-2xl md:text-3xl font-bold text-[#440000] mb-4">الوظيفة غير موجودة</h2>
        <p class="text-lg text-[#666] mb-8 max-w-md">{{ errorMessage() || 'الوظيفة المطلوبة غير موجودة أو تم حذفها.' }}</p>
        <button (click)="navigateToJobs()"
            class="bg-[#ED2924] text-white px-8 py-3 rounded-lg font-semibold hover:bg-[#c41e1a] transition-colors">
            العودة إلى الوظائف
        </button>
    </div>
</section>
}

<!-- Job Content -->
@else if (hasJob()) {
<!-- Hero Section with Job Title -->
<section class="bg-linear">
    <div class="job-hero-section bg-hero overflow-hidden">
        <div class="container h-full mx-auto lg:px-20 relative">
            <div class="job-hero-content pb-20!" >
                <!-- Job Title -->
                <h1 class="job-hero-title">
                    {{ heroTitle() }}
                </h1>

                <!-- Job Info Cards -->
                @if (heroJobInfo().length > 0) {
                <div class="job-info-cards flex gap-3 mt-4 mb-6">
                    @for (info of heroJobInfo(); track $index) {
                    <div class="job-info-card">
                        <span class="job-info-text">{{ info.label }}</span>
                        <span class="job-info-icon" [innerHTML]="sanitizeIcon(info.icon)"></span>
                    </div>
                    }
                </div>
                }

                <!-- Job Description -->
                <p class="job-hero-description">{{ heroParagraph() }}</p>

                <!-- Apply Now Button -->
                @if (heroBtn()) {
                <div class="job-hero-actions mt-6">
                    <button class="job-apply-btn" (click)="scrollToApply()">
                        {{ heroBtnText() }}
                      <img src="/images/icons/arrow-left.png" alt="arrow-left" class="apply-arrow">
                    </button>
                </div>
                }
            </div>
        </div>
    </div>
</section>
}

<!-- Main Content Sections -->
@if (hasJob()) {
<section class="job-content-section container mx-auto lg:px-20 py-12 md:py-20">
    @if (jobSections().length > 0) {
        @for (section of jobSections(); track section.id || $index) {
        <div class="job-section">
            <div class="job-section-header">
                <img src="/images/title/title.png" alt="title-icon" class="section-icon">
                <h2 class="job-section-title">{{ getDataOrPlaceholder(section.title) }}</h2>
            </div>
            @if (section.text && section.text.trim()) {
            <div class="job-section-content" [innerHTML]="sanitizeHtml(section.text)">
            </div>
            } @else {
            <div class="job-section-content text-center py-8">
                <p class="text-gray-400">لا يوجد بيانات</p>
            </div>
            }
        </div>
        }
    } @else {
        <div class="job-section">
            <div class="job-section-header">
                <img src="/images/title/title.png" alt="title-icon" class="section-icon">
                <h2 class="job-section-title">تفاصيل الوظيفة</h2>
            </div>
            <div class="job-section-content text-center py-8">
                <p class="text-gray-400">لا يوجد بيانات</p>
            </div>
        </div>
    }
</section>
}

<!-- Job Application Form -->
@if (hasJob()) {
<section id="apply-form" class="container mx-auto lg:px-20 py-20">
    <div class="flex flex-col h-full">
        <app-section-title [title]="'قدم الآن'" customClass="flex justify-start mb-4">
        </app-section-title>
        <form [formGroup]="jobApplicationForm" (ngSubmit)="onSubmitApplication()" class="flex flex-col gap-6 flex-1" novalidate>
            <!-- Full Name -->
            <div class="flex flex-col gap-1">
                <p-floatlabel variant="on">
                    <input pInputText id="fullName" 
                        formControlName="fullName"
                        [invalid]="fullNameControl?.invalid && fullNameControl?.touched" 
                        class="w-full" />
                    <label for="fullName">الاسم بالكامل</label>
                </p-floatlabel>
                @if (getFullNameError()) {
                    <span class="text-red-500 text-sm mt-1">{{ getFullNameError() }}</span>
                }
            </div>

            <!-- Email -->
            <div class="flex flex-col gap-1">
                <p-floatlabel variant="on">
                    <input pInputText id="email" type="email" 
                        formControlName="email"
                        [invalid]="emailControl?.invalid && emailControl?.touched" 
                        class="w-full" />
                    <label for="email">البريد الالكتروني</label>
                </p-floatlabel>
                @if (getEmailError()) {
                    <span class="text-red-500 text-sm mt-1">{{ getEmailError() }}</span>
                }
            </div>

            <!-- Phone Number -->
            <div class="flex flex-col gap-1">
                <p-floatlabel variant="on">
                    <p-inputGroup>
                        <p-inputGroupAddon class="p-1 cursor-pointer">
                            <p-select [options]="countries" [(ngModel)]="selectedCountryModel"
                                [ngModelOptions]="{standalone: true}" (onChange)="onCountryChange($event.value)"
                                optionLabel="name" [dataKey]="'code'" [style]="{'width': '140px', 'border': 'none'}"
                                [panelStyle]="{'max-height': '300px'}" [showClear]="false" [appendTo]="'self'"
                                class="country-select">
                                <ng-template let-country pTemplate="selectedItem">
                                    <div class="flex items-center gap-2" *ngIf="country">
                                        <span class="fi fi-{{country.code}}"></span>
                                        <span>{{country.dialCode}}</span>
                                    </div>
                                </ng-template>
                                <ng-template let-country pTemplate="item">
                                    <div class="flex items-center gap-2 py-2">
                                        <span class="fi fi-{{country.code}}"></span>
                                        <span>{{country.name}}</span>
                                        <span class="text-gray-500 mr-auto">{{country.dialCode}}</span>
                                    </div>
                                </ng-template>
                            </p-select>
                        </p-inputGroupAddon>
                        <input id="phone" type="tel" pInputText 
                            formControlName="phone"
                            [placeholder]="phonePlaceholder()"
                            (keypress)="onPhoneKeyPress($event)"
                            [invalid]="phoneControl?.invalid && phoneControl?.touched" 
                            class="w-full" />
                    </p-inputGroup>
                    <label for="phone">رقم الهاتف</label>
                </p-floatlabel>
                @if (getPhoneError()) {
                    <span class="text-red-500 text-sm mt-1">{{ getPhoneError() }}</span>
                }
            </div>

            <!-- Experience -->
            <div class="flex flex-col gap-1">
                <p-floatlabel variant="on">
                    <input pInputText id="experience" 
                        formControlName="experience"
                        [invalid]="experienceControl?.invalid && experienceControl?.touched" 
                        class="w-full" />
                    <label for="experience">سنين الخبرة</label>
                </p-floatlabel>
                @if (getExperienceError()) {
                    <span class="text-red-500 text-sm mt-1">{{ getExperienceError() }}</span>
                }
            </div>

            <!-- Expected Salary -->
            <div class="flex flex-col gap-1">
                <p-floatlabel variant="on">
                    <p-inputGroup>
                        <input id="expectedSalary" type="text" pInputText 
                            formControlName="expectedSalary"
                            [invalid]="expectedSalaryControl?.invalid && expectedSalaryControl?.touched" 
                            class="w-full" />
                        <p-inputGroupAddon class="p-1">
                            <span class="salary-suffix-text">بالريال السعودي</span>
                        </p-inputGroupAddon>
                    </p-inputGroup>
                    <label for="expectedSalary">الراتب المتوقع</label>
                </p-floatlabel>
                @if (getExpectedSalaryError()) {
                    <span class="text-red-500 text-sm mt-1">{{ getExpectedSalaryError() }}</span>
                }
            </div>

            <!-- Current Salary -->
            <div class="flex flex-col gap-1">
                <p-floatlabel variant="on">
                    <p-inputGroup>
                        <input id="currentSalary" type="text" pInputText 
                            formControlName="currentSalary"
                            [invalid]="currentSalaryControl?.invalid && currentSalaryControl?.touched" 
                            class="w-full" />
                        <p-inputGroupAddon class="p-1">
                            <span class="salary-suffix-text">بالريال السعودي</span>
                        </p-inputGroupAddon>
                    </p-inputGroup>
                    <label for="currentSalary">الراتب الحالي</label>
                </p-floatlabel>
                @if (getCurrentSalaryError()) {
                    <span class="text-red-500 text-sm mt-1">{{ getCurrentSalaryError() }}</span>
                }
            </div>

            <!-- Cover Letter -->
            <div class="flex flex-col gap-1 flex-1">
                <p-floatlabel variant="on" class="flex-1 flex flex-col">
                    <textarea id="message" rows="5" pInputTextarea 
                        formControlName="message"
                        [invalid]="messageControl?.invalid && messageControl?.touched" 
                        class="w-full flex-1"></textarea>
                    <label for="message">رسالة تعريفية...</label>
                </p-floatlabel>
            </div>

            <!-- File Uploads -->
            <div class="flex flex-col gap-6">
                <!-- Portfolio -->
                <div class="flex flex-col gap-1">
                    <label for="portfolio" class="text-[#440000] font-semibold">محفظة الأعمال</label>
                    <div class="file-upload-area" [class.has-file]="jobApplicationForm.get('portfolio')?.value">
                        <input 
                            type="file" 
                            id="portfolio" 
                            (change)="onPortfolioChange($event)" 
                            class="file-input"
                            accept=".pdf,.doc,.docx,.zip,.rar">
                        <div class="file-upload-content">
                            <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            @if (jobApplicationForm.get('portfolio')?.value) {
                                <p class="file-name">{{ jobApplicationForm.get('portfolio')?.value?.name }}</p>
                            } @else {
                                <p class="file-placeholder">اضغط لرفع الملف</p>
                            }
                        </div>
                    </div>
                </div>

                <!-- CV -->
                <div class="flex flex-col gap-1">
                    <label for="cv" class="text-[#440000] font-semibold">السيرة الذاتية</label>
                    <div class="file-upload-area" [class.has-file]="jobApplicationForm.get('cv')?.value">
                        <input 
                            type="file" 
                            id="cv" 
                            (change)="onCvChange($event)" 
                            class="file-input"
                            accept=".pdf,.doc,.docx">
                        <div class="file-upload-content">
                            <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            @if (jobApplicationForm.get('cv')?.value) {
                                <p class="file-name">{{ jobApplicationForm.get('cv')?.value?.name }}</p>
                            } @else {
                                <p class="file-placeholder">اضغط لرفع الملف</p>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Message -->
            @if (submitSuccess()) {
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">
                    <p class="font-semibold">تم إرسال طلبك بنجاح!</p>
                    <p class="text-sm">شكراً لتقديمك، سنتواصل معك في أقرب وقت ممكن.</p>
                </div>
            }

            <!-- Error Message -->
            @if (submitError()) {
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                    <p class="font-semibold">حدث خطأ</p>
                    <p class="text-sm">{{ submitError() }}</p>
                </div>
            }

            <!-- Submit Button -->
            <app-app-button 
                [btnText]="isSubmitting() ? 'جاري الإرسال...' : 'إرسال'" 
                [disabled]="jobApplicationForm.invalid || isSubmitting()" 
                (buttonClick)="onSubmitApplication()"
                customClass="mt-0! ps-7 pe-3 py-4 bg-[#ED2924] text-white rounded-full flex items-center justify-center transition duration-300">
            </app-app-button>
        </form>
    </div>
</section>
}


